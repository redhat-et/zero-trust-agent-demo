apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: spiffe-demo-ghcr

resources:
  - ../../base

# Use ghcr.io images (pre-built in CI)
images:
  - name: opa-service
    newName: ghcr.io/redhat-et/zero-trust-agent-demo/opa-service
    newTag: latest
  - name: document-service
    newName: ghcr.io/redhat-et/zero-trust-agent-demo/document-service
    newTag: latest
  - name: user-service
    newName: ghcr.io/redhat-et/zero-trust-agent-demo/user-service
    newTag: latest
  - name: agent-service
    newName: ghcr.io/redhat-et/zero-trust-agent-demo/agent-service
    newTag: latest
  - name: web-dashboard
    newName: ghcr.io/redhat-et/zero-trust-agent-demo/web-dashboard
    newTag: latest
  - name: jaeger
    newName: jaegertracing/jaeger
    newTag: "2.15.0"
  - name: otel-collector
    newName: otel/opentelemetry-collector-contrib
    newTag: "0.120.0"

patches:
  # OPA Service - Real SPIFFE with ghcr.io images
  - target:
      kind: Deployment
      name: opa-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8185
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8185"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: spire-agent-socket
          mountPath: /run/spire/agent-sockets
          readOnly: true
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: spire-agent-socket
          csi:
            driver: "csi.spiffe.io"
            readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8185
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8185
          initialDelaySeconds: 5
          periodSeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_COLLECTOR_ENDPOINT
          value: "otel-collector:4317"

  # Document Service - Real SPIFFE with ghcr.io images
  - target:
      kind: Deployment
      name: document-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8184
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8184"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8184
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8184
          initialDelaySeconds: 5
          periodSeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_COLLECTOR_ENDPOINT
          value: "otel-collector:4317"

  # User Service - Real SPIFFE with ghcr.io images
  - target:
      kind: Deployment
      name: user-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8182
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8182"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "https://document-service:8080"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_AGENT_SERVICE_URL
          value: "https://agent-service:8080"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8182
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8182
          initialDelaySeconds: 5
          periodSeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_COLLECTOR_ENDPOINT
          value: "otel-collector:4317"

  # Agent Service - Real SPIFFE with ghcr.io images
  - target:
      kind: Deployment
      name: agent-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8183
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8183"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "https://document-service:8080"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8183
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8183
          initialDelaySeconds: 5
          periodSeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_COLLECTOR_ENDPOINT
          value: "otel-collector:4317"

  # Web Dashboard - Real SPIFFE with ghcr.io images
  - target:
      kind: Deployment
      name: web-dashboard
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_USER_SERVICE_URL
          value: "https://user-service:8080"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_AGENT_SERVICE_URL
          value: "https://agent-service:8080"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "https://document-service:8080"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_COLLECTOR_ENDPOINT
          value: "otel-collector:4317"
