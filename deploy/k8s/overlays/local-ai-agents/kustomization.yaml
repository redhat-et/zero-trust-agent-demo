apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: spiffe-demo-local-ai-agents

# Extends local overlay with AI agent services
resources:
  - ../local
  - ../ai-agents

# Add local images for AI agent services
images:
  - name: summarizer-service
    newName: localhost/spiffe-demo/summarizer-service
    newTag: latest
  - name: reviewer-service
    newName: localhost/spiffe-demo/reviewer-service
    newTag: latest

patches:
  # Summarizer Service - Real SPIFFE with local images
  - target:
      kind: Deployment
      name: summarizer-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8186
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8186"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: replace
        path: /spec/template/spec/containers/0/env/1
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "https://document-service:8080"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8186
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8186
          initialDelaySeconds: 5
          periodSeconds: 5

  # Reviewer Service - Real SPIFFE with local images
  - target:
      kind: Deployment
      name: reviewer-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8187
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8187"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: replace
        path: /spec/template/spec/containers/0/env/1
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "https://document-service:8080"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8187
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8187
          initialDelaySeconds: 5
          periodSeconds: 5

  # Add AI agent service URLs to web-dashboard
  - target:
      kind: Deployment
      name: web-dashboard
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SUMMARIZER_SERVICE_URL
          value: "https://summarizer-service:8000"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_REVIEWER_SERVICE_URL
          value: "https://reviewer-service:8000"

  # Update service ports to use mTLS naming
  - target:
      kind: Service
      name: summarizer-service
    patch: |-
      - op: replace
        path: /spec/ports/0/name
        value: mtls

  - target:
      kind: Service
      name: reviewer-service
    patch: |-
      - op: replace
        path: /spec/ports/0/name
        value: mtls

  # Enable A2A agent discovery on agent-service
  - path: agent-service-discovery-patch.yaml
