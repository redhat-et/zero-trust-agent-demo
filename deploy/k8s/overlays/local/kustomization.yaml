apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: spiffe-demo-local

resources:
  - ../../base

# Use local images (loaded into Kind with `kind load docker-image`)
images:
  - name: opa-service
    newName: localhost/spiffe-demo/opa-service
    newTag: latest
  - name: document-service
    newName: localhost/spiffe-demo/document-service
    newTag: latest
  - name: user-service
    newName: localhost/spiffe-demo/user-service
    newTag: latest
  - name: agent-service
    newName: localhost/spiffe-demo/agent-service
    newTag: latest
  - name: web-dashboard
    newName: localhost/spiffe-demo/web-dashboard
    newTag: latest

patches:
  # OPA Service - Real SPIFFE with local images
  - target:
      kind: Deployment
      name: opa-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8185
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8185"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: spire-agent-socket
          mountPath: /run/spire/agent-sockets
          readOnly: true
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: spire-agent-socket
          csi:
            driver: "csi.spiffe.io"
            readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8185
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8185
          initialDelaySeconds: 5
          periodSeconds: 5

  # Document Service - Real SPIFFE with local images
  - target:
      kind: Deployment
      name: document-service
    patch: |-
      - op: remove
        path: /spec/template/spec/initContainers
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: replace
        path: /spec/template/spec/containers/0/env/3/value
        value: "false"
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8184
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8184"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8184
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8184
          initialDelaySeconds: 5
          periodSeconds: 5

  # User Service - Real SPIFFE with local images
  - target:
      kind: Deployment
      name: user-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8182
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8182"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "https://document-service:8084"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_AGENT_SERVICE_URL
          value: "https://agent-service:8083"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8182
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8182
          initialDelaySeconds: 5
          periodSeconds: 5

  # Agent Service - Real SPIFFE with local images
  - target:
      kind: Deployment
      name: agent-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/ports/-
        value:
          containerPort: 8183
          name: health
      - op: replace
        path: /spec/template/spec/containers/0/ports/0/name
        value: mtls
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_HEALTH_PORT
          value: "8183"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "https://document-service:8084"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8183
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /ready
            port: 8183
          initialDelaySeconds: 5
          periodSeconds: 5

  # Web Dashboard - Real SPIFFE with local images (no health port needed, serves plain HTTP)
  - target:
      kind: Deployment
      name: web-dashboard
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SPIFFE_SOCKET_PATH
          value: "unix:///run/spire/agent-sockets/spire-agent.sock"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_USER_SERVICE_URL
          value: "https://user-service:8082"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_AGENT_SERVICE_URL
          value: "https://agent-service:8083"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "https://document-service:8084"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_ISSUER_URL
          value: "http://keycloak:8080/realms/spiffe-demo"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_CLIENT_ID
          value: "spiffe-demo-dashboard"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_REDIRECT_URL
          value: "http://localhost:8080/auth/callback"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_SKIP_EXPIRY_CHECK
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: spire-agent-socket
            mountPath: /run/spire/agent-sockets
            readOnly: true
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: spire-agent-socket
            csi:
              driver: "csi.spiffe.io"
              readOnly: true
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
