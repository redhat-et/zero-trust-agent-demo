apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: spiffe-demo-mock

resources:
  - ../../base
  - keycloak-nodeport.yaml
  - jaeger-nodeport.yaml

# Use local images (loaded into Kind with `kind load docker-image`)
images:
  - name: opa-service
    newName: localhost/spiffe-demo/opa-service
    newTag: latest
  - name: document-service
    newName: localhost/spiffe-demo/document-service
    newTag: latest
  - name: user-service
    newName: localhost/spiffe-demo/user-service
    newTag: latest
  - name: agent-service
    newName: localhost/spiffe-demo/agent-service
    newTag: latest
  - name: web-dashboard
    newName: localhost/spiffe-demo/web-dashboard
    newTag: latest
  - name: jaeger
    newName: jaegertracing/jaeger
    newTag: "2.15.0"
  - name: otel-collector
    newName: otel/opentelemetry-collector-contrib
    newTag: "0.120.0"

patches:
  # Add mock mode config and probes to all deployments
  - target:
      kind: Deployment
      name: opa-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8085
          initialDelaySeconds: 5
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /health
            port: 8085
          initialDelaySeconds: 2
          periodSeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_COLLECTOR_ENDPOINT
          value: "otel-collector:4317"

  - target:
      kind: Deployment
      name: document-service
    patch: |-
      - op: remove
        path: /spec/template/spec/initContainers
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: replace
        path: /spec/template/spec/containers/0/env/3/value
        value: "false"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8084
          initialDelaySeconds: 5
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /health
            port: 8084
          initialDelaySeconds: 2
          periodSeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_COLLECTOR_ENDPOINT
          value: "otel-collector:4317"

  - target:
      kind: Deployment
      name: user-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "http://document-service:8084"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_AGENT_SERVICE_URL
          value: "http://agent-service:8083"
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8082
          initialDelaySeconds: 5
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /health
            port: 8082
          initialDelaySeconds: 2
          periodSeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_COLLECTOR_ENDPOINT
          value: "otel-collector:4317"

  - target:
      kind: Deployment
      name: agent-service
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "http://document-service:8084"
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8083
          initialDelaySeconds: 5
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /health
            port: 8083
          initialDelaySeconds: 2
          periodSeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OTEL_COLLECTOR_ENDPOINT
          value: "otel-collector:4317"

  - target:
      kind: Deployment
      name: web-dashboard
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_SERVICE_MOCK_SPIFFE
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_USER_SERVICE_URL
          value: "http://user-service:8082"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_AGENT_SERVICE_URL
          value: "http://agent-service:8083"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_DOCUMENT_SERVICE_URL
          value: "http://document-service:8084"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_ISSUER_URL
          value: "http://host.containers.internal:8180/realms/spiffe-demo"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_CLIENT_ID
          value: "spiffe-demo-dashboard"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_REDIRECT_URL
          value: "http://localhost:8080/auth/callback"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: SPIFFE_DEMO_OIDC_SKIP_EXPIRY_CHECK
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 2
          periodSeconds: 5
